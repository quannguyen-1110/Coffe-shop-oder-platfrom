# ?? Gi?i pháp ??ng b? data Shipper gi?a 2 b?ng

## ? V?N ?? BAN ??U

B?n có **2 b?ng riêng bi?t** l?u thông tin shipper:

```
???????????????????????????????????????
?  CoffeeShopUsers (User table)      ?
?  - UserId, Username, Email       ?
?  - FullName, PhoneNumber            ?
?  - VehicleType, LicensePlate        ?
?  - RegistrationStatus, IsActive     ?
???????????????????????????????????????
  ? KHÔNG ??NG B?
???????????????????????????????????????
?  ShipperProfile (Profile table)     ?
?  - ShipperId, FullName, Phone  ?
?  - VehicleType, VehiclePlate        ?
?  - BankAccount, TotalDeliveries ?
???????????????????????????????????????
```

**Khi shipper update profile:**
- ? `ShipperProfile` ???c update
- ? `CoffeeShopUsers` KHÔNG ???c update
- ? Admin v?n th?y data c? t? `CoffeeShopUsers`

---

## ? GI?I PHÁP: SYNC 2 CHI?U

### 1?? **Shipper Update Profile ? Sync sang CoffeeShopUsers**

**File: `Controllers/ShipperController.cs`**

```csharp
[HttpPut("profile")]
public async Task<IActionResult> UpdateProfile([FromBody] UpdateProfileRequest request)
{
    var shipperId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    
    // 1. ? C?p nh?t ShipperProfile
    var profile = await _profileRepo.GetProfileAsync(shipperId);
    if (profile == null)
    {
 profile = new ShipperProfile { ShipperId = shipperId };
    }
  
    // Update ShipperProfile fields
    if (!string.IsNullOrEmpty(request.FullName))
    profile.FullName = request.FullName;
    if (!string.IsNullOrEmpty(request.Phone))
    profile.Phone = request.Phone;
    if (!string.IsNullOrEmpty(request.VehicleType))
      profile.VehicleType = request.VehicleType;
    if (!string.IsNullOrEmpty(request.VehiclePlate))
 profile.VehiclePlate = request.VehiclePlate;
    
    await _profileRepo.CreateOrUpdateProfileAsync(profile);
    
 // 2. ? ??NG B? sang CoffeeShopUsers
    var user = await _userRepo.GetUserByIdAsync(shipperId);
    if (user != null)
    {
        // Sync các field quan tr?ng
        if (!string.IsNullOrEmpty(request.FullName))
            user.FullName = request.FullName;
        if (!string.IsNullOrEmpty(request.Phone))
            user.PhoneNumber = request.Phone;
  if (!string.IsNullOrEmpty(request.VehicleType))
            user.VehicleType = request.VehicleType;
  if (!string.IsNullOrEmpty(request.VehiclePlate))
            user.LicensePlate = request.VehiclePlate;
        
        await _userRepo.UpdateUserAsync(user);
    }
    
    return Ok(new { 
  message = "Profile updated (synced to both tables)",
        profile = profile 
  });
}
```

**K?t qu?:**
```
Shipper update profile
    ?
???????????????????????????????
? 1. Update ShipperProfile    ? ?
???????????????????????????????
    ?
???????????????????????????????
? 2. Sync to CoffeeShopUsers  ? ?
???????????????????????????????
```

---

### 2?? **Admin View Shippers ? Merge t? 2 b?ng**

**File: `Controllers/AdminController.cs`**

```csharp
[HttpGet("shippers")]
public async Task<IActionResult> GetShippers()
{
    var allShippers = await _userRepository.GetUsersByRoleAsync("Shipper");
    var approved = allShippers.Where(s => s.RegistrationStatus == "Approved").ToList();
    
    // ? MERGE v?i ShipperProfile ?? l?y data ??y ??
    var enrichedShippers = new List<object>();
    
    foreach (var shipper in approved)
    {
      var profile = await _profileRepo.GetProfileAsync(shipper.UserId);
    
        enrichedShippers.Add(new
   {
 // Data t? CoffeeShopUsers
            userId = shipper.UserId,
     username = shipper.Username,
   email = shipper.Email,
  isActive = shipper.IsActive,
         registrationStatus = shipper.RegistrationStatus,
       approvedAt = shipper.ApprovedAt,
          
            // Data t? ShipperProfile (?u tiên n?u có)
 fullName = profile?.FullName ?? shipper.FullName,
            phone = profile?.Phone ?? shipper.PhoneNumber,
            vehicleType = profile?.VehicleType ?? shipper.VehicleType,
          licensePlate = profile?.VehiclePlate ?? shipper.LicensePlate,
      
            // Stats t? ShipperProfile (ch? có trong Profile)
            totalDeliveries = profile?.TotalDeliveries ?? 0,
  totalEarnings = profile?.TotalEarnings ?? 0,
  rating = profile?.Rating ?? 0,
            lastActiveAt = profile?.LastActiveAt,

            // Banking info (ch? có trong ShipperProfile)
      bankAccount = profile?.BankAccount,
         bankName = profile?.BankName
        });
    }
    
    return Ok(enrichedShippers);
}
```

**K?t qu?:**
```
Admin view shippers
    ?
???????????????????????????????????
? 1. Query CoffeeShopUsers        ?
?    ? Get basic info (auth, role)?
???????????????????????????????????
    ?
???????????????????????????????????
? 2. Query ShipperProfile   ?
?    ? Get detailed info (stats)  ?
???????????????????????????????????
    ?
???????????????????????????????????
? 3. MERGE & prioritize           ?
?    ? ShipperProfile > User      ?
???????????????????????????????????
```

---

## ?? Data Priority

Khi merge data, **?u tiên ShipperProfile** (vì m?i nh?t):

```javascript
{
  // ? ?u tiên ShipperProfile
  fullName: profile?.FullName ?? shipper.FullName,
  phone: profile?.Phone ?? shipper.PhoneNumber,
  
  // ? Ch? có trong ShipperProfile
  totalDeliveries: profile?.TotalDeliveries ?? 0,
  bankAccount: profile?.BankAccount,
  
  // ? Ch? có trong CoffeeShopUsers
  registrationStatus: shipper.RegistrationStatus,
  isActive: shipper.IsActive
}
```

---

## ?? Flow hoàn ch?nh

### Khi Shipper Update:
```
1. Shipper g?i PUT /api/shipper/profile
    ?
2. Backend update ShipperProfile ?
    ?
3. Backend sync sang CoffeeShopUsers ?
    ?
4. Response: "Synced to both tables"
```

### Khi Admin View:
```
1. Admin g?i GET /api/admin/shippers
    ?
2. Backend query CoffeeShopUsers
    ?
3. Backend query ShipperProfile
    ?
4. Backend merge & return enriched data
    ?
5. Admin th?y data M?I NH?T ?
```

---

## ? UX Changes

### Admin Dashboard s? hi?n th?:

```
????????????????????????????????????????????????????????????????
?  QU?N LÝ SHIPPER     ?
???????????????????????????????????????????????????????????????
? H? TÊN ? EMAIL    ? S?T  ? LO?I XE  ? S? ??N       ?
???????????????????????????????????????????????????????????????
? Nguy?n ? nguyen@...    ? 0901...  ? XE MÁY   ? 125 ??n ?   ?
? V?n A  ?   ? ?          ?       ?
???????????????????????????????????????????????????????????????
? Tr?n   ? tran@...   ? 0902...? XE MÁY? 87 ??n ?    ?
? Th? B  ?            ?   ?          ?   ?
???????????????????????????????????????????????????????????????
```

**Tr??c ?ây:** Hi?n th? "Ch?a c?p nh?t" vì ch? query `CoffeeShopUsers`

**Bây gi?:** Hi?n th? data M?I NH?T t? `ShipperProfile`

---

## ?? Testing

### Test 1: Shipper update profile
```bash
# 1. Shipper login
POST /api/shipper-auth/login
{
  "username": "shipper001",
  "password": "abc123"
}

# 2. Update profile
PUT /api/shipper/profile
Authorization: Bearer <shipper_token>
{
  "fullName": "Nguy?n V?n An M?I",
  "phone": "0909999999",
  "vehicleType": "XE MÁY",
  "vehiclePlate": "59A-12345"
}

# Expected response:
{
  "message": "Profile updated successfully (synced to both tables)",
  "profile": {...}
}
```

### Test 2: Admin view shippers
```bash
# 3. Admin view shippers
GET /api/admin/shippers
Authorization: Bearer <admin_token>

# Expected response:
[
  {
    "userId": "shipper-001",
    "username": "shipper001",
    "email": "shipper@example.com",
    "fullName": "Nguy?n V?n An M?I",  // ? Data m?i
    "phone": "0909999999",    // ? Data m?i
    "vehicleType": "XE MÁY",       // ? Data m?i
  "licensePlate": "59A-12345",       // ? Data m?i
    "totalDeliveries": 125,         // ? T? ShipperProfile
    "totalEarnings": 2500000,
    "registrationStatus": "Approved",
    "isActive": true
  }
]
```

---

## ?? Checklist

### Backend Changes:
- [x] `ShipperController.UpdateProfile()` - Sync to CoffeeShopUsers
- [x] `AdminController.GetShippers()` - Merge from both tables
- [x] `AdminController.GetPendingShippers()` - Merge from both tables
- [x] Add `UserRepository` to ShipperController
- [x] Add `ShipperProfileRepository` to AdminController

### Testing:
- [ ] Test shipper update profile
- [ ] Verify CoffeeShopUsers updated
- [ ] Test admin view shippers
- [ ] Verify merged data displayed

### Frontend:
- [ ] No changes needed (API response structure same)

---

## ?? TÓM T?T

### Gi?i pháp:
1. **Shipper update ? Sync 2 b?ng**
2. **Admin view ? Merge 2 b?ng**

### ?u ?i?m:
- ? Data luôn ??ng b?
- ? Admin th?y data m?i nh?t
- ? Không c?n migrate data c?
- ? Không c?n xóa/refactor b?ng

### Nh??c ?i?m:
- ?? Query 2 b?ng ? h?i ch?m (nh?ng acceptable)
- ?? Duplicate data (nh?ng DynamoDB không t?n nhi?u ti?n)

---

## ?? T?I ?U HÓA SAU NÀY (Optional)

N?u mu?n t?i ?u h?n, có th?:
1. **Ch? dùng 1 b?ng** - Merge ShipperProfile vào CoffeeShopUsers
2. **Cache** - Cache merged data trong memory
3. **Event-driven** - Dùng DynamoDB Streams ?? t? ??ng sync

Nh?ng v?i quy mô hi?n t?i, **gi?i pháp sync 2 chi?u là ?? t?t!** ?
